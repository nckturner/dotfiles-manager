#!/bin/zsh

dotfile_root="$HOME/.dotfiles"
dotfiles="${dotfile_root}/dotfiles"
zsh_sourcefile="${dotfile_root}/bin/sourcefile.zsh"

check_installation() {

    if [[ ! -d $dotfile_root ]] {
        print "Dotfiles was not installed correctly.  Be sure to install it in '~/.dotfiles'.  "
        exit 1
    }
}

add_dotfiles() {
  generate_sourcefile_zsh
  for src in $(find "$dotfiles" -maxdepth 2 -type f -regextype posix-extended -regex ".*rc|.*config|.*zsh|.*\.symlink")
  do
    print -n "Found $src..."
    if [[ $src =~ ".*rc|.*config" ]] {
      # if $src ends with 'rc' or 'config', symlink it to '.$src', i.e. .dotfiles/dotfiles/vim/vimrc -> /home/user/.vimrc
      dst="$HOME/.$(basename "${src##*/}")"
      if [[ -f "$dst" ]] {
        print " Link to $dst already exists."
      } else {
        print -n " Linking: "
        ln -sv "$src" "$dst"
      }
    } elif [[ $src =~ ".*\.symlink" ]] {
      # if $src ends with '.symlink', symlink it to '.src' and remove the .symlink extension.
      dst="$HOME/.$(basename "${${a%.*}##*/}")"
      if [[ -f "$dst" ]] {
        print " Link to $dst already exists."
      } else {
        print -n " Linking: "
        ln -sv "$src" "$dst"
      }
    } elif [[ $src =~ ".*zsh" ]] {
      print " Adding ${src} to sourcefile."
      print "source ${src}" >> "$zsh_sourcefile"
    }
    

  done
}

#install_deps() {
#  print -n "Installing antigen..."
#  if [[ -d "$HOME/.antigen" ]] {
#    print " already exists."
#  } else {
#    git clone https://github.com/zsh-users/antigen.git ~/.antigen
#  }
#
#  print -n "Installing vundle..."
#  if [[ -d "$HOME/.vim/bundle/Vundle.vim" ]] {
#    print " already exists."
#  } else {
#    git clone https://github.com/gmarik/Vundle.vim.git ~/.vim/bundle/Vundle.vim
#    vim +PluginInstall +qall
#  }
#}

generate_sourcefile_zsh() {
  print "Regenerating sourcefile (${zsh_sourcefile})"
  define-heredoc text <<'EOF'
# This file was generated by dotfiles.  Do not modify this file.
# Regenerate it with the bootstrap script.  

EOF
  print $text > $zsh_sourcefile
}

define-heredoc() {
  IFS='\n' read -r -d '' ${1} || true;
}

check_installation
add_dotfiles
#install_deps

